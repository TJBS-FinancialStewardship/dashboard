<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TJBS - Financial Stewardship</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'yf-brand': '#6001D2', // Yahoo Finance Mock
                        'fb-brand': '#CC0000', // Fox Business Mock
                        'cnbc-brand': '#3A606E', // CNBC Mock
                        'bloomberg-brand': '#1F2E7D', // Bloomberg Mock
                        'market-green': '#10B981',
                        'market-red': '#EF4444',
                        'ai-blue': '#3B82F6',
                    }
                }
            }
        }
    </script>
    <style>
        /* Custom scrollbar for news feeds and chat */
        .custom-scrollbar::-webkit-scrollbar {
            width: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: rgba(156, 163, 175, 0.5); /* gray-400 with opacity */
            border-radius: 9999px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }
        /* Specific styling for the fixed disclaimer */
        #disclaimer {
            z-index: 50; /* Ensure it stays on top */
        }
        /* Loading spinner animation */
        .spinner {
            border-top-color: #3B82F6;
            -webkit-animation: spin 1s ease-in-out infinite;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">

    <!-- 1. Persistent Disclaimer -->
    <div id="disclaimer" class="sticky top-0 bg-yellow-100 border-b border-yellow-200 p-2 text-center text-sm font-medium text-yellow-800 shadow-lg">
        <p><strong>Disclaimer:</strong> Content is for informational purposes only. It is not investment advice or a recommendation to buy or sell any security.</p>
    </div>

    <!-- Main Dashboard Container -->
    <div class="container mx-auto p-4 md:p-6 lg:p-8 pt-4">

        <!-- Header and Refresh -->
        <header class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6">
            <h1 class="text-3xl md:text-4xl font-extrabold text-gray-900 tracking-tight mb-2 sm:mb-0">TJBS - Financial Stewardship</h1>
            <div class="flex items-center space-x-3">
                <p id="last-updated" class="text-sm text-gray-500 italic">Last Update: --:--:--</p>
                <button id="refresh-button" class="flex items-center px-4 py-2 bg-ai-blue text-white text-sm font-semibold rounded-lg shadow-md hover:bg-blue-700 transition duration-150 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50">
                    <svg id="refresh-icon" class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.118 0a8 8 0 01-9.336 6.582M20 20v-5h-.582m-15.118 0a8 8 0 019.336-6.582"></path></svg>
                    <div id="loading-spinner" class="hidden w-4 h-4 mr-2 border-2 border-transparent border-t-white rounded-full spinner"></div>
                    <span>Refresh</span>
                </button>
            </div>
        </header>

        <!-- Grid Layout for Main Content -->
        <div class="grid grid-cols-1 gap-6">

            <!-- 1. AI-Generated Market Snapshot (Full Width) -->
            <section class="bg-white p-6 rounded-xl shadow-lg border border-gray-100">
                <h2 class="text-xl font-bold text-ai-blue mb-3 flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l-3 3M15 10v13l3-3M3 6h18M3 10h18M3 14h18M3 18h18"></path></svg>
                    AI Market Snapshot
                </h2>
                <div id="ai-summary-content">
                    <p class="text-gray-500 italic">Generating real-time intelligence...</p>
                </div>
            </section>

            <!-- 2. Financial News Feed (Full Width) -->
            <section class="bg-white p-6 rounded-xl shadow-lg border border-gray-100 h-full">
                <h2 class="text-xl font-bold text-gray-900 mb-2 flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v2m-7 13h2a2 2 0 002-2V9a2 2 0 00-2-2h-2a2 2 0 00-2 2v2M9 13h6"></path></svg>
                    Financial News Feed
                </h2>
                <p class="text-sm text-gray-500 mb-4">High-priority headlines from preferred sources.</p>
                
                <div id="news-feed" class="divide-y divide-gray-100 max-h-[85vh] custom-scrollbar overflow-y-auto pr-2">
                    <!-- News items will be populated here -->
                    <p class="text-sm text-gray-500 py-3">Loading news...</p>
                </div>
            </section>
            
            <!-- Remaining elements grouped for consistent spacing -->
            <div class="space-y-6">

                <!-- 3. Market Movers -->
                <section class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-100">
                        <h2 class="text-xl font-bold text-market-green mb-3 flex items-center">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8"></path></svg>
                            Top 25 Gainers (>$2B Cap)
                        </h2>
                        <div id="gainers-list" class="space-y-2 max-h-96 custom-scrollbar overflow-y-auto pr-2">
                            <!-- Gainers will be populated here -->
                            <p class="text-sm text-gray-500">Loading data...</p>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-100">
                        <h2 class="text-xl font-bold text-market-red mb-3 flex items-center">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 17h8m0 0V9m0 8l-8-8"></path></svg>
                            Top 25 Losers (>$2B Cap)
                        </h2>
                        <div id="losers-list" class="space-y-2 max-h-96 custom-scrollbar overflow-y-auto pr-2">
                            <!-- Losers will be populated here -->
                            <p class="text-sm text-gray-500">Loading data...</p>
                        </div>
                    </div>
                </section>

                <!-- 4. Economic Calendar & Earnings Calendar -->
                <section class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Economic Calendar -->
                    <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-100">
                        <h2 class="text-xl font-bold text-gray-900 mb-3 flex items-center">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h.01M13 11h.01M17 11h.01M7 15h.01M11 15h.01M15 15h.01M7 19h.01M11 19h.01M15 19h.01M4 21h16a2 2 0 002-2V5a2 2 0 00-2-2H4a2 2 0 00-2 2v14a2 2 0 002 2z"></path></svg>
                            U.S. Economic Calendar (30 Days)
                        </h2>
                        <div id="economic-calendar" class="space-y-3 max-h-96 custom-scrollbar overflow-y-auto pr-2">
                            <!-- Calendar will be populated here -->
                            <p class="text-sm text-gray-500">Loading data...</p>
                        </div>
                        <a href="https://www.tradingeconomics.com/calendar" target="_blank" class="mt-4 inline-block text-sm text-blue-600 hover:text-blue-800 font-semibold">More from Trading Economics &rarr;</a>
                    </div>

                    <!-- Earnings Calendar -->
                    <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-100">
                        <h2 class="text-xl font-bold text-gray-900 mb-3 flex items-center">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c1.657 0 3 .895 3 2s-1.343 2-3 2h-1M4 14v1a3 3 0 003 3h5m0-9v6"></path></svg>
                            Upcoming Earnings (Mid/Large Cap)
                        </h2 >
                        <div id="earnings-calendar" class="space-y-3 max-h-96 custom-scrollbar overflow-y-auto pr-2">
                            <!-- Earnings will be populated here -->
                            <p class="text-sm text-gray-500">Loading data...</p>
                        </div>
                        <a href="https://finance.yahoo.com/calendar" target="_blank" class="mt-4 inline-block text-sm text-blue-600 hover:text-blue-800 font-semibold">More from Yahoo Finance &rarr;</a>
                    </div>
                </section>
            </div>
            
        </div>
    </div>

    <!-- AI Assistant Chat Widget HTML -->
    <div id="chat-panel" class="fixed right-4 bottom-4 w-11/12 max-w-sm h-[70vh] max-h-[600px] bg-white rounded-xl shadow-2xl border border-gray-200 flex flex-col transform translate-x-[110%] transition-transform duration-300 ease-in-out z-40">
        <!-- Chat Header -->
        <header class="p-4 bg-ai-blue text-white rounded-t-xl flex justify-between items-center shadow-md">
            <h3 class="text-lg font-bold">AI Financial Assistant</h3>
            <button id="close-chat-button" class="text-white hover:text-gray-200 transition" onclick="toggleChatPanel()">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </header>

        <!-- Chat Messages -->
        <div id="chat-messages" class="flex-grow p-4 space-y-4 overflow-y-auto custom-scrollbar">
            <!-- Messages will be injected here -->
        </div>

        <!-- Chat Input -->
        <div class="p-4 border-t border-gray-200">
            <div id="chat-loading-indicator" class="hidden text-sm text-ai-blue mb-2 flex items-center space-x-2">
                <div class="w-3 h-3 border-2 border-transparent border-t-ai-blue rounded-full spinner"></div>
                <span>Assistant is typing...</span>
            </div>
            <div class="flex space-x-2">
                <input type="text" id="chat-input" placeholder="Ask about stocks, events, or strategy..." class="flex-grow p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-ai-blue" />
                <button id="chat-send-button" disabled class="px-4 py-3 bg-ai-blue text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 transition duration-150 disabled:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"></path></svg>
                </button>
            </div>
        </div>
    </div>

    <!-- Chat Toggle Button -->
    <button id="chat-button" class="fixed right-4 bottom-4 md:right-8 md:bottom-8 p-4 bg-ai-blue text-white rounded-full shadow-lg hover:bg-blue-700 transition duration-150 focus:outline-none focus:ring-4 focus:ring-blue-300 z-50">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 8h10M7 12h4m-4 8h10a2 2 0 002-2V9a2 2 0 00-2-2H7a2 2 0 00-2 2v2a2 2 0 002 2h4l-4 4v-4z"></path></svg>
    </button>

    <script>
        // --- 1. MOCK DATA AND CONFIGURATION ---

        const MOCK_DATA = {
            gainers: [
                { symbol: 'SLDP', name: 'Solid Power', change: 53.96, price: 8.65, marketCap: 2.1 },
                { symbol: 'LMND', name: 'Lemonade', change: 30.97, price: 76.79, marketCap: 4.5 },
                { symbol: 'KW', name: 'Kennedy-Wilson Holdings', change: 30.75, price: 9.78, marketCap: 3.2 },
                { symbol: 'LITE', name: 'Lumentum Holdings', change: 26.30, price: 237.85, marketCap: 5.8 },
                { symbol: 'TDC', name: 'TERADATA Corp.', change: 25.74, price: 26.04, marketCap: 2.9 },
                { symbol: 'MTSR', name: 'Metsera Inc.', change: 20.50, price: 73.18, marketCap: 6.1 },
                { symbol: 'AHCO', name: 'AdaptHealth Corp.', change: 17.38, price: 10.67, marketCap: 2.4 },
                { symbol: 'SANM', name: 'Sanmina Corp.', change: 16.56, price: 163.58, marketCap: 8.7 },
                { symbol: 'VITL', name: 'Vital Farms', change: 16.13, price: 37.37, marketCap: 2.0 },
                { symbol: 'INSP', name: 'Inspire Medical Systems', change: 15.33, price: 85.01, marketCap: 4.9 },
                { symbol: 'VEEV', name: 'Veeva Systems', change: 12.11, price: 180.20, marketCap: 36.5 },
                { symbol: 'PLTR', name: 'Palantir Technologies', change: 9.25, price: 180.74, marketCap: 40.0 },
                { symbol: 'BA', name: 'Boeing Co.', change: 8.88, price: 220.01, marketCap: 125.0 },
                { symbol: 'MSFT', name: 'Microsoft Corp.', change: 7.50, price: 420.00, marketCap: 3000.0 },
                { symbol: 'GOOGL', name: 'Alphabet Inc.', change: 6.90, price: 160.00, marketCap: 2200.0 },
            ],
            losers: [
                { symbol: 'SRPT', name: 'Sarepta Therapeutics', change: -33.74, price: 16.20, marketCap: 2.5 },
                { symbol: 'NSP', name: 'Insperity', change: -17.88, price: 37.03, marketCap: 2.8 },
                { symbol: 'AESI', name: 'Atlas Energy Solutions', change: -15.89, price: 10.64, marketCap: 2.2 },
                { symbol: 'NCLH', name: 'Norwegian Cruise Line', change: -15.28, price: 18.79, marketCap: 8.5 },
                { symbol: 'NVTS', name: 'Navitas Semiconductor', change: -14.61, price: 10.46, marketCap: 3.1 },
                { symbol: 'ZTS', name: 'ZOETIS', change: -13.78, price: 124.46, marketCap: 58.0 },
                { symbol: 'LSCC', name: 'Lattice Semiconductor', change: -13.17, price: 63.23, marketCap: 9.3 },
                { symbol: 'KMB', name: 'Kimberly-Clark', change: -12.10, price: 110.50, marketCap: 36.0 },
                { symbol: 'BYND', name: 'Beyond Meat', change: -11.70, price: 10.15, marketCap: 5.5 },
                { symbol: 'AMD', name: 'Advanced Micro Devices', change: -8.80, price: 150.00, marketCap: 250.0 },
                { symbol: 'NVDA', name: 'NVIDIA Corp.', change: -7.94, price: 190.74, marketCap: 500.0 },
                { symbol: 'PFE', name: 'Pfizer Inc.', change: -5.00, price: 24.00, marketCap: 150.0 },
                { symbol: 'INTC', name: 'Intel Corp.', change: -4.50, price: 37.00, marketCap: 155.0 },
            ],
            news: [
                { source: 'Fox Business', title: 'Fed Signals Rate Hike Pause, But Warns of Inflation Resilience', url: 'https://www.foxbusiness.com/markets/fed-signals-rate-hike-pause', color: 'fb-brand', time: '5 mins ago' },
                { source: 'Yahoo Finance', title: 'Tech Stocks Dive Amidst AI Valuation Fears; NVDA Down 7%', url: 'https://finance.yahoo.com/news/tech-stocks-dive-ai-valuation-140000305.html', color: 'yf-brand', time: '15 mins ago' },
                { source: 'CNBC', title: 'Kimberly-Clark to Acquire Kenvue in Multi-Billion Dollar Deal', url: 'https://www.cnbc.com/2025/11/05/kimberly-clark-kenvue-acquisition.html', color: 'cnbc-brand', time: '30 mins ago' },
                { source: 'Bloomberg', title: 'Global Bond Yields Spike to New Highs on Strong Jobs Report', url: 'https://www.bloomberg.com/news/articles/2025-11-05/global-bond-yields-spike', color: 'bloomberg-brand', time: '1 hour ago' },
                { source: 'Fox Business', title: 'Retail Sales Beat Estimates, Signaling Strong Consumer Spending', url: 'https://www.foxbusiness.com/markets/retail-sales-beat-estimates', color: 'fb-brand', time: '2 hours ago' },
                { source: 'Yahoo Finance', title: 'Energy Sector Rallies as Crude Oil Jumps Past $90 a Barrel', url: 'https://finance.yahoo.com/news/energy-sector-rallies-crude-oil-160000999.html', color: 'yf-brand', time: '3 hours ago' },
                { source: 'CNBC', title: 'Boeing Lands Major New Order from Emirates for 777X Jets', url: 'https://www.cnbc.com/2025/11/05/boeing-emirates-order-777x.html', color: 'cnbc-brand', time: '4 hours ago' },
                { source: 'Bloomberg', title: 'Asian Markets Close Mixed Following Weak Manufacturing Data', url: 'https://www.bloomberg.com/news/articles/2025-11-05/asian-markets-mixed', color: 'bloomberg-brand', time: '5 hours ago' },
                { source: 'Unknown Source', title: 'Cryptocurrency Exchange Coinbase Reports Record Q3 Profits', url: 'https://example.com/crypto-record', color: 'gray-500', time: '6 hours ago' },
            ],
            economicCalendar: [
                { date: 'Nov 8 (Fri)', time: '8:30 AM ET', event: 'Nonfarm Payrolls', forecast: '75K', previous: '79K', impact: 'High' },
                { date: 'Nov 13 (Wed)', time: '8:30 AM ET', event: 'CPI MoM', forecast: '0.3%', previous: '0.4%', impact: 'High' },
                { date: 'Nov 15 (Fri)', time: '10:00 AM ET', event: 'Retail Sales MoM', forecast: '0.5%', previous: '0.2%', impact: 'Medium' },
                { date: 'Nov 20 (Wed)', time: '2:00 PM ET', event: 'FOMC Meeting Minutes', forecast: 'N/A', previous: 'N/A', impact: 'High' },
                { date: 'Nov 22 (Fri)', time: '9:45 AM ET', event: 'PMI Composite', forecast: '51.2', previous: '50.9', impact: 'Medium' },
                { date: 'Nov 27 (Wed)', time: '10:00 AM ET', event: 'Consumer Confidence', forecast: '98.0', previous: '97.5', impact: 'Medium' },
            ],
            earningsCalendar: [
                { date: 'Nov 7 (Thu)', time: 'After Market Close', company: 'ARISTA', ticker: 'ANET', estimate: '$1.70' },
                { date: 'Nov 11 (Mon)', time: 'Before Market Open', company: 'Beyond Meat', ticker: 'BYND', estimate: '($0.85)' },
                { date: 'Nov 14 (Thu)', time: 'After Market Close', company: 'Uber Technologies', ticker: 'UBER', estimate: '$0.15' },
                { date: 'Nov 18 (Mon)', time: 'Before Market Open', company: 'Spotify Technology', ticker: 'SPOT', estimate: '$0.92' },
                { date: 'Nov 21 (Thu)', time: 'After Market Close', company: 'Marathon Petroleum', ticker: 'MPC', estimate: '$4.12' },
                { date: 'Dec 2 (Mon)', time: 'Before Market Open', company: 'Lowe\'s Cos', ticker: 'LOW', estimate: '$3.01' },
            ]
        };

        // --- 2. GLOBAL CHAT STATE AND HELPERS ---
        let isChatOpen = false;
        let chatHistory = [
            { role: "assistant", text: "Hello! I am your AI Financial Assistant. I can help you understand the market snapshot, explain economic events, or summarize a specific stock mover. What would you like to know?" }
        ];

        /**
         * Converts market cap in Billions to a readable string.
         * @param {number} capB - Market Cap in Billions of USD.
         * @returns {string} Formatted string.
         */
        const formatMarketCap = (capB) => {
            if (capB >= 1000) return `$${(capB / 1000).toFixed(1)}T`;
            return `$${capB.toFixed(1)}B`;
        };

        /**
         * Helper to scroll the chat box to the bottom.
         */
        const scrollToBottom = (elementId) => {
            const element = document.getElementById(elementId);
            if (element) {
                element.scrollTop = element.scrollHeight;
            }
        };

        // --- 3. RENDER FUNCTIONS (UI) ---

        /**
         * Renders an individual stock mover item, now clickable.
         */
        const renderMoverItem = (stock) => {
            const isGainer = stock.change >= 0;
            const colorClass = isGainer ? 'text-market-green bg-green-50' : 'text-market-red bg-red-50';
            const sign = isGainer ? '+' : '';
            // Link to Yahoo Finance Quote for the ticker
            const url = `https://finance.yahoo.com/quote/${stock.symbol}`; 

            return `
                <a href="${url}" target="_blank" class="block">
                    <div class="flex justify-between items-center p-2 rounded-lg ${colorClass} transition duration-100 hover:shadow-md hover:bg-opacity-75">
                        <div class="flex items-center space-x-2">
                            <span class="font-mono text-sm font-bold text-gray-900">${stock.symbol}</span>
                            <span class="text-xs text-gray-700">${stock.name}</span>
                        </div>
                        <div class="text-right">
                            <span class="font-semibold text-sm">${sign}${stock.change.toFixed(2)}%</span>
                            <span class="block text-xs text-gray-500">${formatMarketCap(stock.marketCap)}</span>
                        </div>
                    </div>
                </a>
            `;
        };

        /**
         * Renders an individual news item with the new, compact list design.
         */
        const renderNewsItem = (item) => {
            return `
                <a href="${item.url}" target="_blank" class="block py-3 px-1 hover:bg-gray-50 transition duration-150">
                    <div class="flex flex-col md:flex-row md:items-start">
                        <!-- Source and Time (Left side on desktop, stacked on mobile) -->
                        <div class="md:w-1/4 flex-shrink-0 mb-1 md:mb-0">
                            <span class="text-xs font-semibold uppercase text-${item.color} block">${item.source}</span>
                            <span class="text-xs text-gray-500">${item.time}</span>
                        </div>
                        <!-- Title (Main content) -->
                        <h4 class="md:w-3/4 text-sm font-semibold text-gray-800 leading-snug hover:text-ai-blue transition">
                            ${item.title}
                        </h4>
                    </div>
                </a>
            `;
        };

        /**
         * Renders an individual calendar event, now with clickable links.
         */
        const renderCalendarItem = (event, type = 'economic') => {
            const impactClass = event.impact === 'High' ? 'bg-market-red text-white' : 'bg-yellow-100 text-yellow-800';
            let detail = '';
            let url = '#';
            let primaryText = event.event;
            let secondaryText = event.date;

            if (type === 'economic') {
                // Link to a Google search for the economic event
                url = `https://www.google.com/search?q=${encodeURIComponent(event.event + ' data release')}`;
                detail = `
                    <div class="flex justify-between text-xs mt-1 text-gray-600">
                        <span>F/P: ${event.forecast} / ${event.previous}</span>
                        <span class="px-2 py-0.5 text-xs font-semibold rounded-full ${impactClass}">${event.impact}</span>
                    </div>
                `;
                secondaryText = `${event.date} (${event.time.split(' ')[0]})`;

            } else if (type === 'earnings') {
                // Link to the company's earnings calendar on Yahoo Finance
                url = `https://finance.yahoo.com/quote/${event.ticker}/calendar`;
                primaryText = `${event.company} (${event.ticker})`;
                detail = `
                    <div class="flex justify-between text-xs mt-1 text-gray-600">
                        <span class="font-bold">EPS Est: ${event.estimate}</span>
                        <span>Time: ${event.time}</span>
                    </div>
                `;
                secondaryText = `${event.date}`; // Keep only the date here
            }

            return `
                <div class="border-b border-gray-100 pb-2">
                    <a href="${url}" target="_blank" class="block hover:bg-gray-50 p-1 -mx-1 rounded transition duration-150">
                        <div class="flex justify-between items-center text-sm font-medium">
                            <span class="text-gray-800 font-semibold hover:text-ai-blue">${primaryText}</span>
                            <span class="text-gray-500 text-xs">${secondaryText}</span>
                        </div>
                        ${detail}
                    </a>
                </div>
            `;
        };
        
        const renderChat = () => {
            const messagesContainer = document.getElementById('chat-messages');
            messagesContainer.innerHTML = chatHistory.map(message => {
                const isUser = message.role === 'user';
                const bgColor = isUser ? 'bg-gray-100' : 'bg-ai-blue text-white';
                const alignment = isUser ? 'self-end text-right' : 'self-start text-left';
                const roleText = isUser ? 'You' : 'Assistant';
                const avatar = isUser ? 'ðŸ‘¤' : 'ðŸ¤–';

                return `
                    <div class="flex ${isUser ? 'justify-end' : 'justify-start'}">
                        <div class="max-w-[80%] p-3 rounded-xl ${bgColor} shadow-sm ${isUser ? 'rounded-br-none' : 'rounded-bl-none'}">
                            <p class="text-xs font-bold mb-1 ${isUser ? 'text-gray-600' : 'text-blue-200'}">${avatar} ${roleText}</p>
                            <p class="text-sm">${message.text}</p>
                        </div>
                    </div>
                `;
            }).join('');
            scrollToBottom('chat-messages');
        };

        // --- 4. API FUNCTIONS (GEMINI) ---

        /**
         * Generates the AI summary using the Gemini API.
         * Includes exponential backoff for robustness.
         */
        const generateAISummary = async (maxRetries = 5) => {
            const contentDiv = document.getElementById('ai-summary-content');
            contentDiv.innerHTML = `<div class="flex items-center space-x-2 text-blue-600">
                <div class="w-4 h-4 border-2 border-transparent border-t-blue-600 rounded-full spinner"></div>
                <span>Analyzing market data...</span>
            </div>`;

            const systemPrompt = "You are a specialized Financial Market Intelligence AI. Provide a concise, single-paragraph summary of today's U.S. stock market activity. Highlight the most recent high-impact economic data (like CPI, NFP, Fed decisions), key sector movements (e.g., Tech/AI volatility), and notable intraday stock movers. Ensure the tone is objective and analytical.";
            // The prompt uses mock data details to ensure a consistent, relevant summary even though it's mock
            const userQuery = `Generate a current market summary based on the following key points:
- Recent Economic Data: CPI YoY is at 3.0%. Nonfarm Payrolls (NFP) recently missed forecast (Actual 22K vs. Forecast 75K).
- Central Bank Sentiment: Fed officials indicate a 'higher-for-longer' interest rate outlook, dampening rate cut hopes.
- Top News Themes: Heavy volatility in mega-cap AI stocks (Nvidia, Palantir) due to valuation concerns. Major M&A activity: Kimberly-Clark acquiring Kenvue.
- Intraday Movers: Extreme single-day volatility, with companies like Solid Power (53% gain) and Sarepta (-33% loss) driving headlines.`;

            const apiKey = ""; // Canvas will provide this if needed
            // FIX: Using the FQDN for stability against the 'Failed to parse URL' error
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            
            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                tools: [{ "google_search": {} }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            for (let attempt = 0; attempt < maxRetries; attempt++) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        if (response.status === 429 && attempt < maxRetries - 1) {
                            const delay = Math.pow(2, attempt) * 1000 + Math.random() * 1000;
                            await new Promise(resolve => setTimeout(resolve, delay));
                            continue;
                        }
                        throw new Error(`API returned status code ${response.status}`);
                    }

                    const result = await response.json();
                    const text = result.candidates?.[0]?.content?.parts?.[0]?.text || "Error: Could not retrieve AI summary content.";
                    
                    contentDiv.innerHTML = `<p class="text-gray-700 leading-relaxed">${text}</p>`;
                    return;

                } catch (error) {
                    console.error(`Attempt ${attempt + 1} failed (Summary):`, error);
                    if (attempt === maxRetries - 1) {
                        contentDiv.innerHTML = `<p class="text-market-red font-semibold">Error: Failed to fetch AI Market Snapshot after ${maxRetries} attempts. Check console for details.</p>`;
                    }
                }
            }
        };

        /**
         * Sends a message to the AI Assistant and gets a response.
         */
        const sendChatMessage = async () => {
            const input = document.getElementById('chat-input');
            const button = document.getElementById('chat-send-button');
            const loadingIndicator = document.getElementById('chat-loading-indicator');

            const userText = input.value.trim();
            if (!userText) return;

            // 1. Update UI with user message
            chatHistory.push({ role: "user", text: userText });
            input.value = '';
            button.disabled = true;
            loadingIndicator.classList.remove('hidden');
            renderChat();

            // 2. Prepare API call
            const promptContext = chatHistory.map(m => ({
                role: m.role,
                parts: [{ text: m.text }]
            }));

            const systemPrompt = "You are a concise financial assistant. Answer user questions about financial markets, stocks, and economic events based on the provided data or general financial knowledge. If asked about real-time data or prices not explicitly in the dashboard, use Google Search grounding. Keep your responses brief (2-3 sentences max).";
            
            const apiKey = ""; 
            // FIX: Using the FQDN for stability against the 'Failed to parse URL' error
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

            const payload = {
                contents: promptContext,
                tools: [{ "google_search": {} }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`API returned status code ${response.status}`);
                }

                const result = await response.json();
                const assistantText = result.candidates?.[0]?.content?.parts?.[0]?.text || "I apologize, I could not process that request.";
                
                // 3. Update UI with assistant message
                chatHistory.push({ role: "assistant", text: assistantText });

            } catch (error) {
                console.error("Chat API Error:", error);
                chatHistory.push({ role: "assistant", text: "I'm having trouble connecting to the intelligence network right now. Please try again later." });
            } finally {
                // 4. Reset UI
                loadingIndicator.classList.add('hidden');
                button.disabled = input.value.trim() === '';
                renderChat();
            }
        };


        // --- 5. DASHBOARD RENDER FUNCTIONS ---

        const renderMovers = (data) => {
            document.getElementById('gainers-list').innerHTML = data.gainers.map(renderMoverItem).join('');
            document.getElementById('losers-list').innerHTML = data.losers.map(renderMoverItem).join('');
        };

        const renderNews = (data) => {
            if (Array.isArray(data.news) && data.news.length > 0) {
                document.getElementById('news-feed').innerHTML = data.news.map(renderNewsItem).join('');
            } else {
                document.getElementById('news-feed').innerHTML = '<p class="text-sm text-gray-500 py-3">No high-priority headlines available.</p>';
            }
        };

        const renderCalendars = (data) => {
            document.getElementById('economic-calendar').innerHTML = data.economicCalendar.map(item => renderCalendarItem(item, 'economic')).join('');
            document.getElementById('earnings-calendar').innerHTML = data.earningsCalendar.map(item => renderCalendarItem(item, 'earnings')).join('');
        };

        const updateLastUpdated = () => {
            const now = new Date();
            const timeString = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true });
            document.getElementById('last-updated').textContent = `Last Update: ${timeString}`;
        };

        /**
         * Toggles the loading state of the dashboard and refresh button.
         */
        const toggleLoadingState = (isLoading) => {
            const refreshButton = document.getElementById('refresh-button');
            const refreshIcon = document.getElementById('refresh-icon');
            const loadingSpinner = document.getElementById('loading-spinner');

            refreshButton.disabled = isLoading;
            if (isLoading) {
                refreshIcon.classList.add('hidden');
                loadingSpinner.classList.remove('hidden');
                refreshButton.querySelector('span').textContent = 'Loading...';
            } else {
                loadingSpinner.classList.add('hidden');
                refreshIcon.classList.remove('hidden');
                refreshButton.querySelector('span').textContent = 'Refresh';
            }
        };

        /**
         * Toggles the visibility of the chat panel.
         */
        const toggleChatPanel = () => {
            const chatPanel = document.getElementById('chat-panel');
            isChatOpen = !isChatOpen;
            chatPanel.style.transform = isChatOpen ? 'translateX(0)' : 'translateX(110%)';
            if (isChatOpen) {
                scrollToBottom('chat-messages');
                document.getElementById('chat-input').focus();
            }
        };


        /**
         * Main function to initialize and refresh the entire dashboard.
         */
        const initDashboard = async () => {
            toggleLoadingState(true);

            // 1. Generate AI Summary (API call)
            // Using await here ensures the loading spinner stays until the summary is complete
            await generateAISummary();

            // 2. Render Mock Data sections
            renderMovers(MOCK_DATA);
            renderNews(MOCK_DATA);
            renderCalendars(MOCK_DATA);

            // 3. Update time and complete loading state
            updateLastUpdated();
            toggleLoadingState(false);
        };


        // --- 6. EVENT LISTENERS AND INITIALIZATION ---
        window.onload = () => {
            // Initial dashboard load
            initDashboard();
            renderChat(); // Render initial chat message

            // Setup Dashboard Refresh Button
            document.getElementById('refresh-button').addEventListener('click', initDashboard);

            // Setup Chat Toggler
            document.getElementById('chat-button').addEventListener('click', toggleChatPanel);
            document.getElementById('close-chat-button').addEventListener('click', toggleChatPanel);

            // Setup Chat Input
            const chatInput = document.getElementById('chat-input');
            const chatSendButton = document.getElementById('chat-send-button');

            chatInput.addEventListener('input', () => {
                chatSendButton.disabled = chatInput.value.trim() === '';
            });

            chatInput.addEventListener('keydown', (event) => {
                if (event.key === 'Enter' && !chatSendButton.disabled) {
                    event.preventDefault(); // Prevent new line in input
                    sendChatMessage();
                }
            });

            chatSendButton.addEventListener('click', sendChatMessage);
        };

    </script>
</body>
</html>
